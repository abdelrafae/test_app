<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Monte Carlo Studio – Bounds-Only (PyScript)</title>

  <!-- PyScript (Python in the browser) -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar"><h1>Monte Carlo Studio – Bounds-Only (PyScript)</h1></header>

  <main class="container">

    <section class="card">
      <h2>Settings</h2>
      <div class="grid-4">
        <div class="row"><label>Iterations</label><input id="iters" type="number" min="100" step="1000" value="50000"></div>
        <div class="row"><label>Random Seed</label><input id="seed" type="number" value="42"></div>
        <div class="row"><label>Use LHS</label><input id="useLhs" type="checkbox" checked></div>
        <div class="row"><label>Impose Correlations</label><input id="useCorr" type="checkbox"></div>
      </div>
      <div class="row">
        <label>Central coverage % for (min, max)</label>
        <input id="coverage" type="range" min="50" max="99" step="1" value="90" oninput="document.getElementById('covVal').textContent=this.value+'%';">
        <span id="covVal">90%</span>
      </div>
      <p class="hint">Normal/Lognormal: treat min/max as central coverage bounds (e.g., 90% → ±1.645σ).</p>
    </section>

    <section class="card">
      <div class="row">
        <h2 style="margin:0;">Variables</h2>
        <div style="text-align:right">
          <label for="kVars" style="margin-right:8px;">Number of variables</label>
          <input id="kVars" type="number" min="1" max="20" value="4" style="width:90px">
          <button id="applyK" class="secondary" onclick="buildVars()">Apply</button>
        </div>
      </div>
      <p class="hint">Distributions: fixed, uniform, triangular (sym), normal, lognormal, PERT (sym, λ=4). Min/Max accept 5 decimals.</p>
      <div id="vars"></div>
    </section>

    <section class="card" id="corrSection" style="display:none;">
      <h2>Correlation Matrix</h2>
      <p class="hint">Edit the matrix (1.0 on diagonal). Values in [-0.95, 0.95]. Must be symmetric & positive-definite.</p>
      <div id="corrTable"></div>
    </section>

    <section class="card">
      <h2>Model Expression</h2>
      <p class="hint">Use your variable names exactly. Example: <code>Qi*365 - CAPEX</code>. The result is OUTPUT. Use <code>**</code> or <code>^</code> for power.</p>
      <input id="expr" type="text" value="X1+X2+X3+X4">
      <div class="btns">
        <button id="run" py-click="run_sim()">Run Simulation</button>
        <button id="clear" class="secondary" py-click="clear_results()">Clear results</button>
      </div>
    </section>

    <section class="card">
      <h2>Results</h2>
      <div class="metrics">
        <div><div class="m-label">Mean</div><div class="m-val" id="mMean">-</div></div>
        <div><div class="m-label">Std Dev</div><div class="m-val" id="mStd">-</div></div>
        <div><div class="m-label">P10</div><div class="m-val" id="mP10">-</div></div>
        <div><div class="m-label">P50</div><div class="m-val" id="mP50">-</div></div>
        <div><div class="m-label">P90</div><div class="m-val" id="mP90">-</div></div>
      </div>

      <h3>Preview (first 10 rows)</h3>
      <div id="preview"></div>

      <h3>Charts</h3>
      <div class="charts">
        <div class="chart"><div id="hist"></div><div class="c-title">Output Distribution (Histogram)</div></div>
        <div class="chart"><div id="cdf"></div><div class="c-title">Empirical CDF</div></div>
        <div class="chart"><div id="tornado"></div><div class="c-title">Pearson Correlation with OUTPUT</div></div>
      </div>

      <div class="btns">
        <button id="dlData" class="secondary" py-click="download_data()">Download Simulated Data (CSV)</button>
        <button id="dlSummary" class="secondary" py-click="download_summary()">Download Summary (CSV)</button>
      </div>
    </section>
  </main>

  <footer class="foot">© <span id="year"></span> MC Studio</footer>

  <!-- Build variable rows with JS (simple DOM helper) -->
  <script>
    const DIST_LIST = ["fixed","uniform","triangular","normal","lognormal","PERT"];
    function buildVars(){
      const k = parseInt(document.getElementById("kVars").value);
      const wrap = document.getElementById("vars");
      wrap.innerHTML="";
      for(let i=0;i<k;i++){
        const div = document.createElement("div");
        div.className = "vcard";
        div.innerHTML = `
          <div class="vgrid">
            <div><label>Name</label><input class="v_name" value="X${i+1}"></div>
            <div><label>Distribution</label>
              <select class="v_dist">${DIST_LIST.map((d,j)=>`<option value="${d}" ${i===1&&j===3?"selected":(j===1?"selected":"")}>${d}</option>`).join("")}</select>
            </div>
            <div><label>min</label><input class="v_min" type="number" step="0.00001" value="${i===0?0:"0.00000"}"></div>
            <div><label>max</label><input class="v_max" type="number" step="0.00001" value="${i===0?1:"1.00000"}"></div>
          </div>`;
        wrap.appendChild(div);
      }
      // refresh correlation matrix visibility
      document.getElementById("corrSection").style.display =
        (document.getElementById("useCorr").checked && k>1) ? "" : "none";
      buildCorr();
    }
    function buildCorr(){
      const k = parseInt(document.getElementById("kVars").value);
      const useCorr = document.getElementById("useCorr").checked;
      const sec = document.getElementById("corrSection");
      sec.style.display = (useCorr && k>1) ? "" : "none";
      if(!(useCorr && k>1)) return;
      const tbl = document.createElement("table");
      tbl.style.borderCollapse="collapse"; tbl.style.width="100%";
      const header = document.createElement("tr");
      header.innerHTML = "<th></th>" + Array.from({length:k}, (_,j)=>`<th>X${j+1}</th>`).join("");
      tbl.appendChild(header);
      for(let i=0;i<k;i++){
        const tr = document.createElement("tr");
        tr.innerHTML = `<th style="text-align:left">X${i+1}</th>` +
          Array.from({length:k}, (_,j)=>{
            const val = (i===j)?1:0;
            return `<td><input class="corr" data-i="${i}" data-j="${j}" type="number" step="0.01" min="-0.95" max="0.95" value="${val}" style="width:80px"></td>`;
          }).join("");
        tbl.appendChild(tr);
      }
      const target = document.getElementById("corrTable");
      target.innerHTML=""; target.appendChild(tbl);
    }
    document.getElementById("useCorr").addEventListener("change", buildCorr);
    buildVars();
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <!-- Python app -->
  <py-config>
    packages = [
      "numpy",
      "matplotlib"
    ]
  </py-config>

  <py-script src="main.py"></py-script>
</body>
</html>
